# May conflict with NVIDIA drivers loading during boot
- name: Blacklist nouveau drivers
  register: nvidia_nouveau_driver_blacklist
  copy:
    dest: /etc/modprobe.d/blacklist-nouveau.conf
    content: |
      blacklist nouveau
      options nouveau modeset=0

- name: Reboot after nouveau driver blacklist update
  when: nvidia_nouveau_driver_blacklist.changed
  reboot:

# NVIDIA driver install require gcc and make
# and that gcc version matches the one used to compile kernel
# Identify gcc version used for kernel and install expected gcc version
- name: remove packages used by previous install methods
  register: previous_install_method_package_remove
  apt:
    name: "{{ item }}"
    state: absent
    purge: true
  loop:
    - build-essential
    - gcc-multilib
    - dkms

- name: Reboot after previous install method package removal
  when: previous_install_method_package_remove.changed
  reboot:

- name: install driver required packages
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - make

- name: Get GCC version used to compile the kernel
  command: cat /proc/version
  register: kernel_version_output

- name: Extract GCC version from kernel version output
  set_fact:
    gcc_version: "{{ kernel_version_output.stdout | regex_search('gcc-([1-9]+)',  '\\1') | first }}"

- debug:
    msg: Found kernel compiled with GCC version '{{ gcc_version }}'

- name: Install matching GCC version
  apt:
    name: "gcc-{{ gcc_version }}"
    state: present

- name: Set installed GCC version as default
  alternatives:
    name: gcc
    link: /usr/bin/gcc
    path: /usr/bin/gcc-{{ gcc_version }}

- name: Set CC as GCC
  alternatives:
    name: cc
    link: /usr/bin/cc
    path: /usr/bin/gcc

- name: Get current NVIDIA driver version (error expected and ignored if driver not installed yet)
  slurp:
    src: /sys/module/nvidia/version
  register: nvidia_driver_version_file
  ignore_errors: true # expected that version file may not yet exist if driver not installed

- name: Set NVIDIA driver version var
  when: nvidia_driver_version_file is success
  set_fact:
    nvidia_driver_version: "{{ nvidia_driver_version_file.content | b64decode | trim }}"

- name: Set NVIDIA driver version var (not installed)
  when: nvidia_driver_version_file is not success
  set_fact:
    nvidia_driver_version: "none"

- name: Show NVIDIA driver version
  ansible.builtin.debug:
    msg: "Current NVIDIA driver version: {{ nvidia_driver_version }}"

# Install driver only if version do not match
# .run file should uninstall any existing version
- name: Download NVIDIA driver installer
  when: nvidia_driver_version != nvidia_driver_dotrun_install_version
  get_url:
    url: https://download.nvidia.com/XFree86/Linux-x86_64/{{ nvidia_driver_dotrun_install_version }}/NVIDIA-Linux-x86_64-{{ nvidia_driver_dotrun_install_version }}.run
    dest: /tmp/NVIDIA-Linux-x86_64-{{ nvidia_driver_dotrun_install_version }}.run
    mode: '0755'

- name: Download NVIDIA driver SHA256 checksum
  when: nvidia_driver_version != nvidia_driver_dotrun_install_version
  get_url:
    url: https://download.nvidia.com/XFree86/Linux-x86_64/{{ nvidia_driver_dotrun_install_version }}/NVIDIA-Linux-x86_64-{{ nvidia_driver_dotrun_install_version }}.run.sha256sum
    dest: /tmp/NVIDIA-Linux-x86_64-{{ nvidia_driver_dotrun_install_version }}.run.sha256sum

- name: Verify SHA256 checksum
  when: nvidia_driver_version != nvidia_driver_dotrun_install_version
  command:
    chdir: /tmp
    cmd: "sha256sum -c /tmp/NVIDIA-Linux-x86_64-{{ nvidia_driver_dotrun_install_version }}.run.sha256sum"
  register: sha256_check
  failed_when: sha256_check.rc != 0

- name: Install NVIDIA driver
  when: nvidia_driver_version != nvidia_driver_dotrun_install_version
  command: /tmp/NVIDIA-Linux-x86_64-{{ nvidia_driver_dotrun_install_version }}.run --no-questions --ui=none

- name: Reboot after dotrun driver install
  when: nvidia_driver_version != nvidia_driver_dotrun_install_version
  reboot:
